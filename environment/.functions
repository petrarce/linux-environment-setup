#!/bin/bash
function replace() {
	set -x
	echo replace \"$1\" with \"$2\"
    	sed -E "s,$1,$2,g" -i `git grep --name-only  "$1"`
	set +x
}

function genFlameGraph() {
    set -x
    perfDataFilePath=${1}
    svgOutput=${2}
    perfDataFile=`basename ${perfDataFilePath}`
    tmpFile="/tmp/${perfDataFile}.out.perf-folded"
    cat ${perfDataFilePath} | c++filt | ~/apps/FlameGraph/stackcollapse-perf.pl > ${tmpFile} && 
        ~/apps/FlameGraph/flamegraph.pl --width 1900 --minwidth 2 ${tmpFile} > ${svgOutput}

    rm ${tmpFile} || true
    set +x
}

function runRemoteScript() {
    set -x
    
    host=${1}
    pathToScript=${2}
    shift
    shift
    ssh ${host} "sh -s " -- < ${pathToScript} $@

    set +x
}

function runVlcMp4HttpStream(){


	getopt -o p:s: -l -port:-src -- "$@"
	if [ "$?" !== "0" ]; then
		return 1
	fi 

	local ARGS="$(getopt -o p:s:v -l -port:-src: -- "$@")"
	eval set -- "${ARGS}"

	local httpPort=80
	local srcVideo=""
	local verbose=""
	while true; do
		case "${1}" in
			-s|-src) srcVideo="${2}"; shift 2;;
			-p|-port) httpPort="${2}"; shift 2;;
			-v) verbose="-vvv"; shift;;
			--) shift; break;;
			*) echo "Unexpected option $1"; return 1;;
		esac
	done

	cvlc ${verbose} \
		--sout '#transcode{vcodec=h264}:std{access=http{mime=video/mp4},mux=ts,dst=:'"${httpPort}"'}' \
		--loop \
		--sout-keep \
		"$(realpath "${srcVideo}")"

}

hg() {
    history | grep "$1"
}

function setup-toolchain-environment() {
	local environmentSetupScript=${1}
	CURRENT_PATH="${PATH}"
	source ${environmentSetupScript}
	export PATH="${PATH}:${CURRENT_PATH}"
}

function setup-template() {
	local targetDirectory="${1}"
	local templateGithubLink="${2}"
	mkdir "${targetDirectory}"
	# wget https://github.com/petrarce/cmake-project-template/archive/refs/heads/master.zip -O "${targetDirectory}/master.zip"
	wget "${templateGithubLink}" -O "${targetDirectory}/master.zip"
	unzip -d "${targetDirectory}" "${targetDirectory}/master.zip"
	rm "${targetDirectory}/master.zip"
}

function setup-cmake-template() {
	setup-template ${1} https://github.com/petrarce/cmake-project-template/archive/refs/heads/master.zip
}

function perf-flamegraph-from-script-file() {
	PERF_SCRIPT_FILE_PATH="$(realpath ${1})"

	OUT_FILE_PATH="$(realpath ${2})"
	OUT_FILE_NAME="$(basename ${OUT_FILE_PATH})"

	#cat ${PERF_FILE_PATH} | perf-flamegraph "${PERF_FILE_DIR}/${PERF_FILE_NAME}.svg"
	stackcollapse-perf.pl "${PERF_SCRIPT_FILE_PATH}" > "/tmp/${OUT_FILE_NAME}.perf-folded";
	flamegraph.pl --width 1900 --minwidth 2 "/tmp/${OUT_FILE_NAME}.perf-folded" > "${OUT_FILE_PATH}"
}


function perf-script() {
	local FILE_PATH="${1}"
	local LOCAL_PERF_DATA="${PWD}/perf.data"
	if [ -f "${LOCAL_PERF_DATA}" ]; then
		echo-err "$0 failed: ${LOCAL_PERF_DATA} already exists"
	fi
	ln -s "${FILE_PATH}" "${PWD}/perf.data"
	perf script | c++filt
	rm perf.data
}

function perf-to-svg {
	if [ "${1}" == "--help" ]; then
		echo  "usage: perf-to-svg <text-name> <PID>"
		return;
	fi
	local TEST_NAME="${1}"
	local PROCES_PID="${2}"
	if [ -z "${TEST_NAME}" ] || [ -z "${PROCES_PID}" ]; then
		return;
	fi 

	perf-record-dwarf -p "${PROCES_PID}" -o "${TEST_NAME}".perf -- sleep 30
	perf-script "${TEST_NAME}.perf" > "${TEST_NAME}.script";
	perf-flamegraph-from-script-file "${TEST_NAME}.script" "${TEST_NAME}.svg"
	ns "FINISH perf-to-svg ${TEST_NAME}"
}

print_progress() {
	local progress="$1"
	local msg="${2}"
	local bar_length=20
	local fill_length=$((progress * bar_length / 100))
	local empty_length=$((bar_length - fill_length))

	 printf "\r[%-*s%*s] %d:$msg%%" "$fill_length" "" "$empty_length" "" "$progress"
}
function git-merge-for-commit(){
	TARGET_COMMIT="${1}";
	HEAD_COMMIT="${2}";
	
	local merge_commit_str=$(git log "${TARGET_COMMIT}"^.."${HEAD_COMMIT}" --merges --format="%H" | tac);
	local merge_commits;
	IFS=$'\n' read -r -d '' -a merge_commits <<< "${merge_commit_str}";
	local num_commits="${#merge_commits[@]}";

	echo "num_commits=${num_commits}";

	for((i = 0; i < num_commits; i++)); do

		local prgs=$((${i} * 100 / ${num_commits}));
		print_progress "${prgs}";
		
		local merge_commit="${merge_commits[i]}"
		local target_commit_str_grep="$(git log --format="%H" ${merge_commit}^..${merge_commit} | grep "${TARGET_COMMIT}")";
		if [ -n "${target_commit_str_grep}" ]; then 
			echo "${TARGET_COMMIT} came from $(git show --no-patch ${merge_commit})"; 
			return;
		fi;
	done
	echo "No merge commit found for the target commit: ${TARGET_COMMIT} starting from ${HEAD_COMMIT}"
}

function android-logcat-app() {

	local package_name="${1}"

	adb logcat --pid=$(adb shell pidof -s "${package_name}")
}

function android-app-admin-signature-checksum() {
	local path_to_app="${1}"

	keytool  -printcert -jarfile "$(realpath "${path_to_app}")" \
		| grep -Po "(?<=SHA256:) .*" \
		| xxd -r -p \
		| openssl base64 \
		| tr -d '=' \
		| tr -- '+/=' '-_'
}